---
id: T090
title: Fix 401 Error on Purchase Credits Flow (Token Handling in H5)
status: Done
updated_at: 2025-06-11
epic: E08
effort: M
risk: Medium
dependencies: []
assignee: CursorAgent
---

### Description

Investigate and resolve the `HTTP Error 401` occurring during the credit purchase request on H5 builds.  Likely causes:
1. Missing/expired JWT token header in `request.ts` interceptor.
2. Incorrect base URL or CORS preflight issues.

Design solution:
• Implement **silent token refresh** (refresh endpoint or re-login) before executing purchase if token expired.
• If refresh fails, redirect user to login with toast.

### Acceptance Criteria

- [x] Purchase API call succeeds on H5 with valid token and returns 200/201.
- [x] Silent refresh flow renews token transparently when 401 returned.
- [x] If refresh fails user is redirected to login; UX copy displayed.
- [x] Automated Vitest mocks expired token and asserts refresh path.

### Context Binding

- **Code:** `@/frontend/src/utils/request.ts`, `@/frontend/src/store/auth.*`, backend auth middleware.

### Agent Notes

Ensure `Authorization: Bearer <token>` header is present.  Check token retrieval from Pinia store vs localStorage when page reloads. 